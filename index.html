<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DayReady">
<meta name="theme-color" content="#111111">
<title>DayReady</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300;1,9..40,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #111111;
  --surface: #191919;
  --surface2: #1f1f1f;
  --surface3: #252525;
  --border: #2a2a2a;
  --border2: #333333;
  --text: #e8e4df;
  --text2: #9a958e;
  --text3: #5c5852;
  --accent: #c4a882;
  --accent-dim: rgba(196,168,130,0.08);
  --green: #8fbf8f;
  --green-dim: rgba(143,191,143,0.08);
  --amber: #c9a96e;
  --amber-dim: rgba(201,169,110,0.08);
  --red: #c47070;
  --safe-top: env(safe-area-inset-top, 44px);
  --safe-bot: env(safe-area-inset-bottom, 34px);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; -webkit-font-smoothing: antialiased; font-weight: 300; }
.app { display: flex; flex-direction: column; height: 100%; max-width: 430px; margin: 0 auto; }
.status-bar { height: var(--safe-top); flex-shrink: 0; background: var(--bg); }
.tab-bar { display: flex; background: var(--bg); border-top: 1px solid var(--border); padding-bottom: var(--safe-bot); flex-shrink: 0; }
.tab { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 10px 0 8px; border: none; background: transparent; color: var(--text3); font-family: 'DM Sans', sans-serif; font-size: 0.58rem; font-weight: 400; letter-spacing: 0.06em; cursor: pointer; transition: color 0.25s; }
.tab.active { color: var(--accent); }
.tab-icon { font-size: 1.15rem; line-height: 1; }
.pages { flex: 1; overflow: hidden; position: relative; }
.page { position: absolute; inset: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 24px 20px; display: none; opacity: 0; transform: translateY(4px); transition: opacity 0.3s ease, transform 0.3s ease; }
.page.active { display: block; opacity: 1; transform: translateY(0); }
.page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 28px; }
.page-title { font-family: 'DM Sans', sans-serif; font-size: 1.5rem; font-weight: 300; letter-spacing: -0.02em; line-height: 1.1; color: var(--text); }
.page-subtitle { font-size: 0.72rem; color: var(--text3); margin-top: 5px; font-family: 'DM Mono', monospace; font-weight: 300; }
.time-badge { font-family: 'DM Mono', monospace; font-size: 0.9rem; font-weight: 300; color: var(--text2); text-align: right; line-height: 1.3; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
.intention-banner { border-bottom: 1px solid var(--border); padding: 0 0 20px 0; margin-bottom: 20px; animation: fadeIn 0.4s ease backwards; }
.intention-label { font-family: 'DM Sans', sans-serif; font-size: 0.65rem; font-weight: 400; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text3); margin-bottom: 10px; }
.intention-display { font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-style: italic; font-weight: 300; color: var(--text); line-height: 1.6; cursor: pointer; }
.intention-display.empty { color: var(--text3); font-style: normal; font-size: 0.85rem; }
.intention-display.editing-mode { display: none; }
.intention-input-wrap { display: none; }
.intention-input-wrap.editing { display: block; }
.intention-input { width: 100%; background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-style: italic; font-weight: 300; color: var(--text); line-height: 1.6; resize: none; height: 56px; border-bottom: 1px solid var(--border2); padding-bottom: 6px; margin-bottom: 12px; }
.intention-input::placeholder { color: var(--text3); font-style: italic; }
.intention-btn-row { display: flex; gap: 8px; }
.intention-save { background: var(--accent); border: none; border-radius: 4px; padding: 8px 18px; font-family: 'DM Mono', monospace; font-size: 0.72rem; font-weight: 400; color: var(--bg); cursor: pointer; }
.intention-cancel { background: transparent; border: 1px solid var(--border2); border-radius: 4px; padding: 8px 16px; font-family: 'DM Mono', monospace; font-size: 0.72rem; font-weight: 400; color: var(--text3); cursor: pointer; }
.weather-hero { border-bottom: 1px solid var(--border); padding: 0 0 20px 0; position: relative; margin-bottom: 20px; animation: fadeIn 0.4s 0.05s ease backwards; }
.weather-loading { display: flex; align-items: center; gap: 10px; color: var(--text3); font-size: 0.8rem; padding: 12px 0; font-family: 'DM Mono', monospace; font-weight: 300; }
.weather-loaded { display: none; }
.weather-hero.loaded .weather-loading { display: none; }
.weather-hero.loaded .weather-loaded { display: block; }
.weather-location { font-family: 'DM Mono', monospace; font-size: 0.6rem; font-weight: 400; letter-spacing: 0.08em; text-transform: lowercase; color: var(--text3); margin-bottom: 12px; }
.weather-main { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 16px; }
.weather-temp { font-family: 'DM Sans', sans-serif; font-size: 3.2rem; font-weight: 300; letter-spacing: -0.04em; line-height: 1; color: var(--text); }
.weather-temp sup { font-size: 1.1rem; font-weight: 300; vertical-align: super; color: var(--text3); }
.weather-icon-big { font-size: 2.4rem; line-height: 1; opacity: 0.7; }
.weather-desc { font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 300; color: var(--text2); margin-bottom: 16px; }
.weather-stats { display: flex; gap: 0; }
.weather-stat { flex: 1; text-align: left; }
.weather-stat-val { font-family: 'DM Mono', monospace; font-size: 0.85rem; font-weight: 400; color: var(--text); }
.weather-stat-lbl { font-size: 0.55rem; color: var(--text3); margin-top: 2px; text-transform: lowercase; letter-spacing: 0.06em; font-family: 'DM Mono', monospace; font-weight: 300; }
.weather-refresh { position: absolute; top: 0; right: 0; background: none; border: none; padding: 4px; color: var(--text3); cursor: pointer; font-size: 0.85rem; opacity: 0.5; transition: opacity 0.2s; }
.weather-refresh:hover { opacity: 1; }
.report-card { border-bottom: 1px solid var(--border); padding: 0 0 20px 0; margin-bottom: 20px; animation: fadeIn 0.4s 0.1s ease backwards; }
.report-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
.report-ai-badge { font-family: 'DM Mono', monospace; font-size: 0.55rem; font-weight: 400; letter-spacing: 0.08em; text-transform: lowercase; color: var(--text3); padding: 2px 6px; border: 1px solid var(--border); border-radius: 2px; }
.report-title { font-family: 'DM Sans', sans-serif; font-size: 0.88rem; font-weight: 400; color: var(--text2); }
.report-section { margin-bottom: 14px; }
.report-section-title { font-family: 'DM Sans', sans-serif; font-size: 0.6rem; font-weight: 400; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text3); margin-bottom: 8px; }
.report-body { font-size: 0.85rem; line-height: 1.7; color: var(--text2); font-weight: 300; }
.report-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.chip { background: transparent; border: 1px solid var(--border); border-radius: 3px; padding: 4px 10px; font-size: 0.72rem; color: var(--text2); font-family: 'DM Sans', sans-serif; font-weight: 300; }
.chip.green { border-color: rgba(143,191,143,0.25); color: var(--green); }
.chip.accent { border-color: rgba(196,168,130,0.25); color: var(--accent); }
.chip.amber { border-color: rgba(201,169,110,0.25); color: var(--amber); }
.report-loading { display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 20px; color: var(--text3); font-size: 0.8rem; text-align: center; font-family: 'DM Mono', monospace; font-weight: 300; }
.pulse-ring { width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--text3); border-top-color: transparent; animation: spin 1.2s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.evening-prep-card { border-bottom: 1px solid var(--border); padding: 0 0 20px 0; margin-bottom: 20px; animation: fadeIn 0.4s 0.15s ease backwards; }
.evening-prep-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.evening-prep-title { font-family: 'DM Sans', sans-serif; font-size: 0.88rem; font-weight: 400; color: var(--text2); }
.evening-prep-badge { font-family: 'DM Mono', monospace; font-size: 0.55rem; font-weight: 400; letter-spacing: 0.08em; text-transform: lowercase; color: var(--text3); padding: 2px 6px; border: 1px solid var(--border); border-radius: 2px; }
.evening-checklist { display: flex; flex-direction: column; gap: 2px; }
.evening-item { display: flex; align-items: center; gap: 12px; padding: 11px 0; cursor: pointer; transition: all 0.15s; border-bottom: 1px solid rgba(42,42,42,0.5); }
.evening-item:last-child { border-bottom: none; }
.evening-item:active { opacity: 0.7; }
.evening-check { width: 16px; height: 16px; border-radius: 2px; border: 1px solid var(--border2); flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 0.6rem; color: transparent; }
.evening-item.checked .evening-check { background: var(--accent); border-color: var(--accent); color: var(--bg); }
.evening-item.checked .evening-item-text { text-decoration: line-through; color: var(--text3); }
.evening-item-emoji { font-size: 0.9rem; }
.evening-item-text { font-size: 0.82rem; color: var(--text2); flex: 1; font-weight: 300; }
.evening-prep-empty { font-size: 0.8rem; color: var(--text3); font-family: 'DM Sans', sans-serif; font-weight: 300; }
.week-plan-grid { display: flex; flex-direction: column; gap: 2px; margin-bottom: 20px; }
.week-plan-row { display: flex; align-items: stretch; background: transparent; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
.week-plan-row:last-child { border-bottom: none; }
.week-plan-row:active { background: var(--surface); }
.week-plan-row.today { background: var(--surface); }
.week-plan-row.has-workout .week-plan-day-num { color: var(--green); }
.week-plan-row.today .week-plan-day-num { color: var(--accent); }
.week-plan-day-col { width: 48px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 14px 6px; gap: 1px; }
.week-plan-day-abbr { font-family: 'DM Mono', monospace; font-size: 0.55rem; font-weight: 400; letter-spacing: 0.06em; text-transform: lowercase; color: var(--text3); }
.week-plan-row.today .week-plan-day-abbr { color: var(--accent); }
.week-plan-day-num { font-family: 'DM Mono', monospace; font-size: 1rem; font-weight: 400; color: var(--text2); }
.week-plan-content { flex: 1; padding: 12px 10px 12px 12px; display: flex; flex-direction: column; justify-content: center; gap: 4px; min-height: 58px; }
.week-plan-workout-chips { display: flex; flex-wrap: wrap; gap: 6px; }
.week-plan-note { font-size: 0.72rem; color: var(--text3); font-style: italic; font-weight: 300; }
.week-plan-rest { font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--text3); font-weight: 300; }
.week-plan-add-hint { font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--accent); font-weight: 400; }
.week-plan-edit-col { display: flex; align-items: center; padding-right: 12px; color: var(--text3); font-size: 0.75rem; opacity: 0.4; }
.week-strip { display: flex; gap: 6px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; margin-bottom: 22px; scrollbar-width: none; }
.week-strip::-webkit-scrollbar { display: none; }
.day-pill { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 3px; width: 46px; padding: 10px 0; border-radius: 4px; border: 1px solid var(--border); background: transparent; cursor: pointer; transition: all 0.2s; position: relative; }
.day-pill.today { border-color: var(--accent); }
.day-pill.selected { background: var(--accent); border-color: var(--accent); }
.day-pill.has-workout::after { content: ''; position: absolute; bottom: 5px; width: 4px; height: 4px; border-radius: 50%; background: var(--green); }
.day-pill.selected::after { background: var(--bg); }
.day-pill-abbr { font-family: 'DM Mono', monospace; font-size: 0.52rem; font-weight: 400; letter-spacing: 0.06em; text-transform: lowercase; color: var(--text3); }
.day-pill.selected .day-pill-abbr { color: rgba(17,17,17,0.6); }
.day-pill.today:not(.selected) .day-pill-abbr { color: var(--accent); }
.day-pill-num { font-family: 'DM Mono', monospace; font-size: 0.9rem; font-weight: 400; color: var(--text2); }
.day-pill.selected .day-pill-num { color: var(--bg); }
.workout-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 18px; margin-bottom: 18px; display: none; }
.workout-panel.visible { display: block; animation: fadeIn 0.25s ease; }
.workout-panel-title { font-family: 'DM Sans', sans-serif; font-size: 0.9rem; font-weight: 400; margin-bottom: 16px; }
.workout-types-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 14px; }
.wtype-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 12px 4px; border-radius: 4px; border: 1px solid var(--border); background: transparent; cursor: pointer; transition: all 0.15s; }
.wtype-btn.selected { background: var(--green-dim); border-color: rgba(143,191,143,0.35); }
.wtype-btn-icon { font-size: 1.15rem; }
.wtype-btn-label { font-family: 'DM Mono', monospace; font-size: 0.52rem; font-weight: 400; letter-spacing: 0.05em; text-transform: lowercase; color: var(--text3); }
.wtype-btn.selected .wtype-btn-label { color: var(--green); }
.workout-note { width: 100%; background: transparent; border: 1px solid var(--border); border-radius: 4px; padding: 12px 14px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 300; color: var(--text); resize: none; height: 52px; outline: none; margin-bottom: 12px; transition: border-color 0.2s; }
.workout-note:focus { border-color: var(--accent); }
.workout-note::placeholder { color: var(--text3); }
.btn-row { display: flex; gap: 8px; }
.btn { flex: 1; padding: 12px; border: none; border-radius: 4px; font-family: 'DM Mono', monospace; font-size: 0.78rem; font-weight: 400; cursor: pointer; transition: all 0.15s; }
.btn-save { background: var(--accent); color: var(--bg); }
.btn-save:active { opacity: 0.85; }
.btn-cancel { background: transparent; color: var(--text3); border: 1px solid var(--border); }
.workout-week-list { display: flex; flex-direction: column; gap: 2px; }
.workout-day-row { display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); padding: 14px 0; }
.workout-day-row:last-child { border-bottom: none; }
.workout-day-label { font-family: 'DM Mono', monospace; font-size: 0.82rem; font-weight: 400; min-width: 40px; color: var(--text2); }
.workout-day-types { display: flex; flex-wrap: wrap; gap: 6px; flex: 1; }
.workout-day-del { background: none; border: none; color: var(--text3); font-size: 0.9rem; cursor: pointer; padding: 4px; opacity: 0.5; }
.pack-section { margin-bottom: 24px; }
.pack-section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
.pack-section-day { font-family: 'DM Sans', sans-serif; font-size: 0.88rem; font-weight: 400; }
.pack-section-types { display: flex; gap: 6px; }
.pack-item { display: flex; align-items: center; gap: 12px; padding: 11px 0; border-bottom: 1px solid rgba(42,42,42,0.5); cursor: pointer; -webkit-user-select: none; user-select: none; }
.pack-item:last-child { border-bottom: none; }
.pack-item:active { opacity: 0.7; }
.pack-check { width: 16px; height: 16px; border-radius: 2px; border: 1px solid var(--border2); flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 0.6rem; color: transparent; }
.pack-item.checked .pack-check { background: var(--green); border-color: var(--green); color: var(--bg); }
.pack-item.checked .pack-item-text { text-decoration: line-through; color: var(--text3); }
.pack-item-emoji { font-size: 0.95rem; }
.pack-item-text { font-size: 0.82rem; color: var(--text2); flex: 1; font-weight: 300; }
.dots-loader span { display: inline-block; width: 4px; height: 4px; background: var(--text3); border-radius: 50%; margin: 0 2px; animation: dotPop 1.2s ease-in-out infinite; }
.dots-loader span:nth-child(2){animation-delay:0.2s} .dots-loader span:nth-child(3){animation-delay:0.4s}
@keyframes dotPop { 0%,80%,100%{transform:scale(0.5);opacity:0.3} 40%{transform:scale(1);opacity:1} }
.empty { text-align: center; padding: 36px 20px; color: var(--text3); }
.empty-icon { font-size: 2rem; margin-bottom: 10px; opacity: 0.5; }
.empty-text { font-size: 0.82rem; line-height: 1.6; font-family: 'DM Sans', sans-serif; font-weight: 300; }
.section-label { font-family: 'DM Sans', sans-serif; font-size: 0.6rem; font-weight: 400; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text3); margin-bottom: 10px; margin-top: 22px; }
.section-label:first-child { margin-top: 0; }
.page-bottom { height: 24px; }
.toast { position: fixed; bottom: calc(var(--safe-bot) + 72px); left: 50%; transform: translateX(-50%) translateY(16px); background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; padding: 9px 18px; font-family: 'DM Mono', monospace; font-size: 0.75rem; font-weight: 400; color: var(--text); pointer-events: none; opacity: 0; transition: all 0.28s ease; white-space: nowrap; z-index: 999; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.stretch-section { margin-bottom: 24px; }
.stretch-section-title { font-family: 'DM Sans', sans-serif; font-size: 0.6rem; font-weight: 400; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text3); margin-bottom: 12px; }
.stretch-item { display: flex; align-items: center; gap: 12px; padding: 11px 0; border-bottom: 1px solid rgba(42,42,42,0.5); cursor: pointer; -webkit-user-select: none; user-select: none; }
.stretch-item:last-child { border-bottom: none; }
.stretch-item:active { opacity: 0.7; }
.stretch-check { width: 16px; height: 16px; border-radius: 2px; border: 1px solid var(--border2); flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 0.6rem; color: transparent; }
.stretch-item.checked .stretch-check { background: var(--green); border-color: var(--green); color: var(--bg); }
.stretch-item.checked .stretch-text { text-decoration: line-through; color: var(--text3); }
.stretch-emoji { font-size: 0.95rem; }
.stretch-text { font-size: 0.82rem; color: var(--text2); flex: 1; font-weight: 300; }
.stretch-hold { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--text3); font-weight: 300; flex-shrink: 0; }
.calc-card { border-bottom: 1px solid var(--border); padding: 0 0 20px 0; margin-bottom: 20px; animation: fadeIn 0.4s ease backwards; }
.calc-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.calc-title { font-family: 'DM Sans', sans-serif; font-size: 0.88rem; font-weight: 400; color: var(--text2); }
.calc-form-row { display: flex; gap: 10px; margin-bottom: 10px; }
.calc-field { flex: 1; display: flex; flex-direction: column; gap: 4px; }
.calc-label { font-family: 'DM Mono', monospace; font-size: 0.55rem; font-weight: 400; letter-spacing: 0.06em; text-transform: lowercase; color: var(--text3); }
.calc-input { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 10px 12px; font-family: 'DM Mono', monospace; font-size: 0.85rem; font-weight: 300; color: var(--text); outline: none; transition: border-color 0.2s; }
.calc-input:focus { border-color: var(--accent); }
.calc-select { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 10px 12px; font-family: 'DM Mono', monospace; font-size: 0.82rem; font-weight: 300; color: var(--text); outline: none; -webkit-appearance: none; appearance: none; cursor: pointer; transition: border-color 0.2s; }
.calc-select:focus { border-color: var(--accent); }
.calc-result { margin-top: 16px; padding: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; display: none; animation: fadeIn 0.3s ease; }
.calc-result.visible { display: block; }
.calc-result-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
.calc-result-row:not(:last-child) { border-bottom: 1px solid var(--border); }
.calc-result-label { font-family: 'DM Sans', sans-serif; font-size: 0.78rem; font-weight: 300; color: var(--text2); }
.calc-result-val { font-family: 'DM Mono', monospace; font-size: 0.9rem; font-weight: 400; color: var(--accent); }
.calc-result-val.green { color: var(--green); }
.calc-activity-note { margin-top: 10px; font-family: 'DM Mono', monospace; font-size: 0.68rem; font-weight: 300; color: var(--text3); line-height: 1.5; }
.todo-item { display: flex; align-items: center; gap: 12px; padding: 11px 0; border-bottom: 1px solid rgba(42,42,42,0.5); cursor: pointer; }
.todo-item:last-child { border-bottom: none; }
.todo-check { width: 16px; height: 16px; border-radius: 2px; border: 1px solid var(--border2); flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 0.6rem; color: transparent; }
.todo-item.checked .todo-check { background: var(--accent); border-color: var(--accent); color: var(--bg); }
.todo-item.checked .todo-text { text-decoration: line-through; color: var(--text3); }
.todo-text { font-size: 0.82rem; color: var(--text2); flex: 1; font-weight: 300; }
.todo-del { background: none; border: none; color: var(--text3); font-size: 0.8rem; cursor: pointer; padding: 4px; opacity: 0.5; flex-shrink: 0; }
.todo-input-row { display: flex; gap: 8px; margin-bottom: 14px; align-items: center; }
.todo-input { flex: 1; background: transparent; border: none; border-bottom: 1px solid var(--border2); outline: none; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 300; color: var(--text); padding: 8px 0; }
.todo-input::placeholder { color: var(--text3); }
.todo-add-btn { background: var(--accent); border: none; border-radius: 4px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; color: var(--bg); cursor: pointer; flex-shrink: 0; }
.schedule-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 18px; margin-top: 20px; }
.schedule-card-title { font-family: 'DM Sans', sans-serif; font-size: 0.88rem; font-weight: 400; margin-bottom: 14px; color: var(--text2); }
.schedule-row { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; }
.schedule-label { font-family: 'DM Mono', monospace; font-size: 0.68rem; font-weight: 300; color: var(--text3); min-width: 50px; }
.custom-stretch-row { display: flex; gap: 8px; margin-bottom: 14px; align-items: center; }
.custom-stretch-input { flex: 1; background: transparent; border: none; border-bottom: 1px solid var(--border2); outline: none; font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 300; color: var(--text); padding: 8px 0; }
.custom-stretch-input::placeholder { color: var(--text3); }
.stretch-del { background: none; border: none; color: var(--text3); font-size: 0.8rem; cursor: pointer; padding: 4px; opacity: 0.5; flex-shrink: 0; }

</style>
</head>
<body>
<div class="app">
  <div class="status-bar"></div>
  <div class="pages">

    <!-- MORNING -->
    <div class="page active" id="page-morning">
      <div class="page-header">
        <div><div class="page-title">Good Morning</div><div class="page-subtitle" id="morningDate">‚Äî</div></div>
        <div class="time-badge" id="morningTime">‚Äî</div>
      </div>

      <div class="report-card" id="todayTodoCard" style="display:none;">
        <div class="report-header"><div class="report-title">Today's To-Do</div></div>
        <div id="todayTodoList"></div>
      </div>

      <div class="report-card">
        <div class="report-header"><div class="report-title">Tomorrow's To-Do</div></div>
        <div class="todo-input-row">
          <input class="todo-input" id="todoInput" placeholder="Add a to-do for tomorrow..." maxlength="100" onkeydown="if(event.key==='Enter')addTomorrowTodo()">
          <button class="todo-add-btn" onclick="addTomorrowTodo()">+</button>
        </div>
        <div id="tomorrowTodoList"></div>
      </div>

      <div class="weather-hero" id="weatherHero">
        <button class="weather-refresh" onclick="loadWeather()">‚Üª</button>
        <div class="weather-loading"><div class="dots-loader"><span></span><span></span><span></span></div><span>fetching weather...</span></div>
        <div class="weather-loaded">
          <div class="weather-location" id="weatherLocation">‚Äî</div>
          <div class="weather-main">
            <div><div class="weather-temp" id="weatherTemp">‚Äî<sup>¬∞F</sup></div><div class="weather-desc" id="weatherDesc">‚Äî</div></div>
            <div class="weather-icon-big" id="weatherIcon">üå§</div>
          </div>
          <div class="weather-stats">
            <div class="weather-stat"><div class="weather-stat-val" id="statFeels">‚Äî</div><div class="weather-stat-lbl">feels like</div></div>
            <div class="weather-stat"><div class="weather-stat-val" id="statHumidity">‚Äî</div><div class="weather-stat-lbl">humidity</div></div>
            <div class="weather-stat"><div class="weather-stat-val" id="statWind">‚Äî</div><div class="weather-stat-lbl">wind mph</div></div>
          </div>
        </div>
      </div>

      <div class="report-card">
        <div class="report-header"><div class="report-title">Morning Brief</div><div class="report-ai-badge">ai</div></div>
        <div class="report-loading" id="reportLoading"><div class="pulse-ring"></div><div>preparing brief...</div></div>
        <div id="reportContent" style="display:none;"></div>
      </div>

      <div class="evening-prep-card">
        <div class="evening-prep-header"><div class="evening-prep-title">Tonight's Prep</div><div class="evening-prep-badge">Tomorrow</div></div>
        <div id="eveningPrepContent"><div class="evening-prep-empty">No workouts planned for tomorrow.</div></div>
      </div>

      <div class="report-card">
        <div class="report-header"><div class="report-title">Morning Notification</div></div>
        <div id="notifContent">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <span style="font-size:0.82rem;color:var(--text2);font-weight:300;">Send brief &amp; intention at:</span>
            <input type="time" id="notifTime" value="07:00" style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:6px 10px;font-family:'DM Mono',monospace;font-size:0.82rem;color:var(--text);outline:none;">
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-save" id="notifEnableBtn" onclick="toggleNotifications()" style="flex:1;">Enable Notifications</button>
          </div>
          <div id="notifStatus" style="margin-top:10px;font-size:0.75rem;color:var(--text3);font-family:'DM Mono',monospace;"></div>
        </div>
      </div>

      <div class="page-bottom"></div>
    </div>

    <!-- PLAN -->
    <div class="page" id="page-plan">
      <div class="page-header">
        <div><div class="page-title">Week Plan</div><div class="page-subtitle" id="weekRangeLabel">‚Äî</div></div>
      </div>
      <div id="weekSummaryBar" style="margin-bottom:20px;"></div>
      <div class="section-label">This Week</div>
      <div class="week-plan-grid" id="weekPlanGrid"></div>
      <div class="section-label">To-Do</div>
      <div id="planTodoBlock" style="margin-bottom:14px;"></div>
      <div class="page-bottom"></div>
    </div>

    <!-- WORKOUTS -->
    <div class="page" id="page-workouts">
      <div class="page-header"><div><div class="page-title">Workouts</div><div class="page-subtitle">plan your week</div></div></div>
      <div class="week-strip" id="weekStrip"></div>
      <div class="workout-panel" id="workoutPanel">
        <div class="workout-panel-title" id="workoutPanelTitle">Add workout</div>
        <div class="workout-types-grid">
          <button class="wtype-btn" data-type="Run" onclick="toggleWType(this)"><span class="wtype-btn-icon">üèÉ</span><span class="wtype-btn-label">run</span></button>
          <button class="wtype-btn" data-type="Lift" onclick="toggleWType(this)"><span class="wtype-btn-icon">üèãÔ∏è</span><span class="wtype-btn-label">lift</span></button>
          <button class="wtype-btn" data-type="Bike" onclick="toggleWType(this)"><span class="wtype-btn-icon">üö¥</span><span class="wtype-btn-label">bike</span></button>
          <button class="wtype-btn" data-type="Swim" onclick="toggleWType(this)"><span class="wtype-btn-icon">üèä</span><span class="wtype-btn-label">swim</span></button>
          <button class="wtype-btn" data-type="Yoga" onclick="toggleWType(this)"><span class="wtype-btn-icon">üßò</span><span class="wtype-btn-label">yoga</span></button>
          <button class="wtype-btn" data-type="HIIT" onclick="toggleWType(this)"><span class="wtype-btn-icon">‚ö°</span><span class="wtype-btn-label">hiit</span></button>
          <button class="wtype-btn" data-type="Walk" onclick="toggleWType(this)"><span class="wtype-btn-icon">üö∂</span><span class="wtype-btn-label">walk</span></button>
          <button class="wtype-btn" data-type="Sport" onclick="toggleWType(this)"><span class="wtype-btn-icon">üéæ</span><span class="wtype-btn-label">sport</span></button>
          <button class="wtype-btn" data-type="Ruck" onclick="toggleWType(this)"><span class="wtype-btn-icon">üéí</span><span class="wtype-btn-label">ruck</span></button>
        </div>
        <textarea class="workout-note" id="workoutNote" placeholder="Notes (optional)"></textarea>
        <div class="btn-row">
          <button class="btn btn-save" onclick="saveWorkout()">save</button>
          <button class="btn btn-cancel" onclick="closePanel()">cancel</button>
        </div>
      </div>
      <div class="workout-week-list" id="workoutList"></div>

      <div class="schedule-card">
        <div class="schedule-card-title">Quick Schedule</div>
        <div class="workout-types-grid" id="scheduleTypesGrid">
          <button class="wtype-btn" data-type="Run" onclick="toggleSchedType(this)"><span class="wtype-btn-icon">üèÉ</span><span class="wtype-btn-label">run</span></button>
          <button class="wtype-btn" data-type="Lift" onclick="toggleSchedType(this)"><span class="wtype-btn-icon">üèãÔ∏è</span><span class="wtype-btn-label">lift</span></button>
          <button class="wtype-btn" data-type="Bike" onclick="toggleSchedType(this)"><span class="wtype-btn-icon">üö¥</span><span class="wtype-btn-label">bike</span></button>
          <button class="wtype-btn" data-type="Swim" onclick="toggleSchedType(this)"><span class="wtype-btn-icon">üèä</span><span class="wtype-btn-label">swim</span></button>
          <button class="wtype-btn" data-type="Yoga" onclick="toggleSchedType(this)"><span class="wtype-btn-icon">üßò</span><span class="wtype-btn-label">yoga</span></button>
          <button class="wtype-btn" data-type="HIIT" onclick="toggleSchedType(this)"><span class="wtype-btn-icon">‚ö°</span><span class="wtype-btn-label">hiit</span></button>
          <button class="wtype-btn" data-type="Walk" onclick="toggleSchedType(this)"><span class="wtype-btn-icon">üö∂</span><span class="wtype-btn-label">walk</span></button>
          <button class="wtype-btn" data-type="Sport" onclick="toggleSchedType(this)"><span class="wtype-btn-icon">üéæ</span><span class="wtype-btn-label">sport</span></button>
          <button class="wtype-btn" data-type="Ruck" onclick="toggleSchedType(this)"><span class="wtype-btn-icon">üéí</span><span class="wtype-btn-label">ruck</span></button>
        </div>
        <div class="schedule-row">
          <span class="schedule-label">repeat</span>
          <select class="calc-select" id="scheduleFreq" style="flex:1;">
            <option value="1">Every day</option>
            <option value="2" selected>Every 2 days</option>
            <option value="3">Every 3 days</option>
            <option value="4">Every 4 days</option>
          </select>
        </div>
        <div class="btn-row">
          <button class="btn btn-save" onclick="applySchedule()">apply to week</button>
          <button class="btn btn-cancel" onclick="clearSchedule()">clear week</button>
        </div>
      </div>

      <div class="page-bottom"></div>
    </div>

    <!-- PACK -->
    <div class="page" id="page-pack">
      <div class="page-header"><div><div class="page-title">Pack List</div><div class="page-subtitle">what to bring each day</div></div></div>
      <div id="packContent"></div>
      <div class="page-bottom"></div>
    </div>

    <!-- BODY -->
    <div class="page" id="page-body">
      <div class="page-header"><div><div class="page-title">Body</div><div class="page-subtitle">stretch &amp; fuel</div></div></div>

      <div class="section-label" style="margin-top:0;">Daily Stretches</div>
      <div id="stretchContent"></div>

      <div class="stretch-section" style="margin-top:20px;">
        <div class="stretch-section-title">Add Your Own</div>
        <div class="custom-stretch-row">
          <input class="custom-stretch-input" id="customStretchName" placeholder="Stretch name..." maxlength="60" onkeydown="if(event.key==='Enter')addCustomStretch()">
          <input class="custom-stretch-input" id="customStretchHold" placeholder="Hold" maxlength="10" style="max-width:70px;" onkeydown="if(event.key==='Enter')addCustomStretch()">
          <button class="todo-add-btn" onclick="addCustomStretch()">+</button>
        </div>
      </div>

      <div class="section-label">Calorie Calculator</div>
      <div class="calc-card">
        <div class="calc-header"><div class="calc-title">Your Profile</div></div>
        <div class="calc-form-row">
          <div class="calc-field"><label class="calc-label">sex</label><select class="calc-select" id="calcSex"><option value="male">Male</option><option value="female">Female</option></select></div>
          <div class="calc-field"><label class="calc-label">age</label><input class="calc-input" id="calcAge" type="number" min="1" max="120"></div>
        </div>
        <div class="calc-form-row">
          <div class="calc-field"><label class="calc-label">weight (lbs)</label><input class="calc-input" id="calcWeight" type="number" min="1" max="999"></div>
        </div>
        <div class="calc-form-row">
          <div class="calc-field"><label class="calc-label">height (ft)</label><input class="calc-input" id="calcHeightFt" type="number" min="1" max="8"></div>
          <div class="calc-field"><label class="calc-label">height (in)</label><input class="calc-input" id="calcHeightIn" type="number" min="0" max="11"></div>
        </div>
        <div class="calc-form-row">
          <div class="calc-field"><label class="calc-label">activity level</label><select class="calc-select" id="calcActivity"><option value="1.2">Sedentary (little / no exercise)</option><option value="1.375">Lightly active (1‚Äì3 days / week)</option><option value="1.55">Moderately active (3‚Äì5 days / week)</option><option value="1.725">Very active (6‚Äì7 days / week)</option><option value="1.9">Extra active (intense / physical job)</option></select></div>
        </div>
        <div style="margin-top:14px;"><button class="btn btn-save" onclick="calculateCalories()" style="width:100%;">Calculate</button></div>
        <div class="calc-result" id="calcResult">
          <div class="calc-result-row"><span class="calc-result-label">Basal Metabolic Rate</span><span class="calc-result-val" id="calcBMR">‚Äî</span></div>
          <div class="calc-result-row"><span class="calc-result-label">Daily Calories (TDEE)</span><span class="calc-result-val green" id="calcTDEE">‚Äî</span></div>
          <div class="calc-activity-note" id="calcNote"></div>
        </div>
      </div>

      <div class="page-bottom"></div>
    </div>

  </div>

  <div class="tab-bar">
    <button class="tab active" onclick="switchTab('morning',this)"><span class="tab-icon">‚òÄÔ∏è</span>Morning</button>
    <button class="tab" onclick="switchTab('plan',this);buildPlanPage();"><span class="tab-icon">üìÖ</span>Plan</button>
    <button class="tab" onclick="switchTab('workouts',this)"><span class="tab-icon">üèÉ</span>Train</button>
    <button class="tab" onclick="switchTab('pack',this)"><span class="tab-icon">üéí</span>Pack</button>
    <button class="tab" onclick="switchTab('body',this);renderStretches();"><span class="tab-icon">ü§∏</span>Body</button>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let workouts   = JSON.parse(localStorage.getItem('dr_workouts')   || '{}');
let todos      = JSON.parse(localStorage.getItem('dr_todos')      || '{}');
let weatherData = null;
let selectedDayKey = null, selectedTypes = [];
let scheduleTypes = [];
let customStretches = JSON.parse(localStorage.getItem('dr_custom_stretches') || '[]');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(name, btn) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  const page = document.getElementById('page-'+name);
  page.classList.add('active'); void page.offsetWidth; btn.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CLOCK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DAYS_LONG=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const DAYS_ABB=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const MONTHS_ABB=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function updateClock() {
  const now=new Date(), h=now.getHours(), m=now.getMinutes();
  const ampm=h>=12?'pm':'am', hh=h%12||12;
  document.getElementById('morningTime').textContent=`${hh}:${String(m).padStart(2,'0')} ${ampm}`;
  document.getElementById('morningDate').textContent=`${DAYS_LONG[now.getDay()]}, ${MONTHS[now.getMonth()]} ${now.getDate()}`;
}
setInterval(updateClock,15000); updateClock();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TODOS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function todayTodoKey() { const d=new Date(); return `todo-${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`; }
function tomorrowTodoKey() { const d=new Date(Date.now()+86400000); return `todo-${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`; }

function loadTodos() {
  const todayItems=todos[todayTodoKey()]||[];
  const todayCard=document.getElementById('todayTodoCard');
  const todayList=document.getElementById('todayTodoList');
  if(todayItems.length){
    todayCard.style.display='block';
    todayList.innerHTML=todayItems.map((item,i)=>`<div class="todo-item${item.done?' checked':''}" onclick="toggleTodayTodo(${i})"><div class="todo-check">‚úì</div><span class="todo-text">${item.text}</span></div>`).join('');
  } else { todayCard.style.display='none'; }
  renderTomorrowTodos();
}

function renderTomorrowTodos() {
  const tmItems=todos[tomorrowTodoKey()]||[];
  const list=document.getElementById('tomorrowTodoList');
  if(!tmItems.length){ list.innerHTML='<div style="color:var(--text3);font-size:0.82rem;font-weight:300;">No items yet ‚Äî add your first to-do above.</div>'; return; }
  list.innerHTML=tmItems.map((item,i)=>`<div class="todo-item"><div class="todo-check" style="border-color:var(--border);color:transparent;">‚úì</div><span class="todo-text">${item.text}</span><button class="todo-del" onclick="deleteTomorrowTodo(${i})">‚úï</button></div>`).join('');
}

function addTomorrowTodo() {
  const input=document.getElementById('todoInput'), val=input.value.trim();
  if(!val)return;
  const key=tomorrowTodoKey();
  if(!todos[key])todos[key]=[];
  todos[key].push({text:val,done:false});
  localStorage.setItem('dr_todos',JSON.stringify(todos));
  input.value=''; renderTomorrowTodos(); showToast('to-do added');
}

function deleteTomorrowTodo(i) {
  const key=tomorrowTodoKey();
  if(!todos[key])return;
  todos[key].splice(i,1);
  if(!todos[key].length)delete todos[key];
  localStorage.setItem('dr_todos',JSON.stringify(todos));
  renderTomorrowTodos();
}

function toggleTodayTodo(i) {
  const key=todayTodoKey();
  if(!todos[key]||!todos[key][i])return;
  todos[key][i].done=!todos[key][i].done;
  localStorage.setItem('dr_todos',JSON.stringify(todos));
  loadTodos();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WEATHER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WMO_CODES={0:'Clear sky',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',45:'Foggy',48:'Icy fog',51:'Light drizzle',53:'Drizzle',55:'Heavy drizzle',61:'Light rain',63:'Rain',65:'Heavy rain',71:'Light snow',73:'Snow',75:'Heavy snow',77:'Snow grains',80:'Light showers',81:'Showers',82:'Violent showers',85:'Snow showers',86:'Heavy snow showers',95:'Thunderstorm',96:'Thunderstorm',99:'Severe thunderstorm'};
const WMO_ICONS={0:'‚òÄÔ∏è',1:'üå§',2:'‚õÖ',3:'‚òÅÔ∏è',45:'üå´',48:'üå´',51:'üå¶',53:'üåß',55:'üåß',61:'üå¶',63:'üåß',65:'üåß',71:'üå®',73:'‚ùÑÔ∏è',75:'‚ùÑÔ∏è',77:'‚ùÑÔ∏è',80:'üå¶',81:'üåß',82:'‚õà',85:'üå®',86:'‚ùÑÔ∏è',95:'‚õà',96:'‚õà',99:'‚õà'};

async function loadWeather() {
  const hero=document.getElementById('weatherHero');
  hero.classList.remove('loaded');
  hero.querySelector('.weather-loading').innerHTML='<div class="dots-loader"><span></span><span></span><span></span></div><span>Fetching weather...</span>';
  try {
    const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:12000}));
    const {latitude:lat,longitude:lon}=pos.coords;
    let city='Your Location';
    try { const geo=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`); const gd=await geo.json(); city=gd.address?.city||gd.address?.town||gd.address?.village||gd.address?.county||'Your Location'; } catch(_){}
    const wx=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,relative_humidity_2m,wind_speed_10m,weather_code&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto`);
    const wd=await wx.json(); const cur=wd.current;
    weatherData={temp:Math.round(cur.temperature_2m),feels:Math.round(cur.apparent_temperature),humidity:Math.round(cur.relative_humidity_2m),wind:Math.round(cur.wind_speed_10m),code:cur.weather_code,city};
    document.getElementById('weatherLocation').textContent=city.toLowerCase();
    document.getElementById('weatherTemp').innerHTML=`${weatherData.temp}<sup>¬∞F</sup>`;
    document.getElementById('weatherDesc').textContent=WMO_CODES[cur.weather_code]||'Unknown';
    document.getElementById('weatherIcon').textContent=WMO_ICONS[cur.weather_code]||'üå§';
    document.getElementById('statFeels').textContent=`${weatherData.feels}¬∞`;
    document.getElementById('statHumidity').textContent=`${weatherData.humidity}%`;
    document.getElementById('statWind').textContent=weatherData.wind;
    hero.classList.add('loaded');
    generateMorningReport();
  } catch(err) {
    hero.querySelector('.weather-loading').innerHTML=`<span style="color:var(--red);font-size:0.8rem;">‚ö†Ô∏è ${err.code===1?'Location denied ‚Äî enable in Settings.':'Could not fetch weather.'}</span>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MORNING REPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateMorningReport() {
  if (!weatherData) return;
  const rl=document.getElementById('reportLoading'), rc=document.getElementById('reportContent');
  rl.style.display='flex'; rc.style.display='none';
  const today=new Date(), tKey=dayKey(today), tmKey=dayKey(new Date(today.getTime()+86400000));
  const todayW=workouts[tKey], tomorrowW=workouts[tmKey];
  const todayTodos=(todos[todayTodoKey()]||[]).filter(t=>!t.done).map(t=>t.text);
  const todoSummary=todayTodos.join(', ');
  const prompt=`You are a concise morning assistant. Respond ONLY with valid JSON, no markdown.

Weather: ${weatherData.temp}¬∞F, ${WMO_CODES[weatherData.code]}, feels ${weatherData.feels}¬∞F, wind ${weatherData.wind}mph, humidity ${weatherData.humidity}%
Today: ${todayW?todayW.types.join(' + ')+(todayW.note?` (${todayW.note})`:''):'Rest day'}
Tomorrow: ${tomorrowW?tomorrowW.types.join(' + '):'Rest day'}
Day: ${DAYS_LONG[today.getDay()]}, ${MONTHS[today.getMonth()]} ${today.getDate()}
${todoSummary?`Today's to-do: "${todoSummary}"`:''}

{
  "greeting": "Warm 1-sentence greeting mentioning the day",
  "outfitSummary": "1-sentence outfit advice",
  "outfitItems": ["item1","item2","item3","item4"],
  "todayWorkoutNote": "1 sentence about today workout or rest encouragement",
  "packReminder": "1 sentence about packing, or null if rest day",
  "tomorrowNote": "1 sentence heads-up about tomorrow, or null",
  "intentionNote": "1 short encouraging sentence referencing the to-do items if given, else null",
  "tip": "Practical morning tip, max 12 words"
}`;
  try {
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:800,messages:[{role:'user',content:prompt}]})});
    const data=await res.json();
    let report; try{report=JSON.parse((data.content?.[0]?.text||'{}').replace(/```json|```/g,'').trim());}catch{report=buildFallbackReport();}
    renderReport(report);
  } catch(_) { renderReport(buildFallbackReport()); }
}

function buildFallbackReport() {
  const today=new Date(), w=workouts[dayKey(today)], t=weatherData?.temp||70;
  let outfit,items;
  if(t<=32){outfit="It's freezing ‚Äî bundle up with heavy layers.";items=['Heavy coat','Thermal layers','Gloves','Warm hat','Boots'];}
  else if(t<=50){outfit="Cold ‚Äî a jacket and layers are essential.";items=['Winter jacket','Sweater','Jeans','Boots'];}
  else if(t<=65){outfit="Cool and crisp ‚Äî a light jacket is perfect.";items=['Light jacket','Long sleeve','Chinos','Sneakers'];}
  else if(t<=78){outfit="Mild day ‚Äî casual layers work great.";items=['T-shirt','Light cardigan','Jeans','Sneakers'];}
  else{outfit="Warm out ‚Äî keep it light and breathable.";items=['T-shirt','Shorts','Sneakers','Sunglasses'];}
  return {greeting:`Good morning! Happy ${DAYS_LONG[today.getDay()]}.`,outfitSummary:outfit,outfitItems:items,todayWorkoutNote:w?`${w.types.join(' + ')} is on the schedule ‚Äî let's go.`:'Rest day ‚Äî recovery is part of the work.',packReminder:w?`Pack your ${w.types.map(t=>t.toLowerCase()).join(' and ')} gear.`:null,tomorrowNote:null,intentionNote:null,tip:'Drink a full glass of water before anything else.'};
}

function renderReport(r) {
  const rl=document.getElementById('reportLoading'), rc=document.getElementById('reportContent');
  let html='<div class="report-body">';
  html+=`<div class="report-section"><p>${r.greeting}</p></div>`;
  if(r.intentionNote) html+=`<div class="report-section" style="padding:10px 12px;border-left:1px solid var(--accent);margin-left:2px;"><p style="font-style:italic;color:var(--text2);font-weight:300;">${r.intentionNote}</p></div>`;
  html+=`<div class="report-section"><div class="report-section-title">What To Wear</div><p>${r.outfitSummary}</p><div class="report-chips">`;
  (r.outfitItems||[]).forEach(i=>html+=`<span class="chip">${i}</span>`);
  html+=`</div></div>`;
  if(r.todayWorkoutNote){html+=`<div class="report-section"><div class="report-section-title">Workout</div><p>${r.todayWorkoutNote}</p>`;if(r.packReminder)html+=`<div class="report-chips"><span class="chip green">üéí ${r.packReminder}</span></div>`;html+=`</div>`;}
  if(r.tomorrowNote) html+=`<div class="report-section"><div class="report-section-title">Tomorrow</div><p>${r.tomorrowNote}</p></div>`;
  if(r.tip) html+=`<div style="padding:10px 12px;border-left:1px solid var(--text3);margin-left:2px;"><span style="font-family:'DM Sans',sans-serif;font-size:0.6rem;font-weight:400;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);">Tip  </span><span style="font-size:0.82rem;color:var(--text2);font-weight:300;">${r.tip}</span></div>`;
  html+='</div>';
  rc.innerHTML=html; rl.style.display='none'; rc.style.display='block';
  renderEveningPrep();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EVENING PREP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EVENING_MAP={
  Run:[{e:'üëü',t:'Set out running shoes'},{e:'ü©≥',t:'Lay out athletic clothes'},{e:'üíß',t:'Fill water bottle'},{e:'üß¢',t:'Find your cap or headband'}],
  Lift:[{e:'üèãÔ∏è',t:'Pack gym bag'},{e:'üëü',t:'Set out gym shoes'},{e:'üíß',t:'Fill water bottle'},{e:'üéß',t:'Charge headphones'}],
  Bike:[{e:'üö¥',t:'Check tire pressure'},{e:'ü™ñ',t:'Find your helmet'},{e:'üíß',t:'Fill water bottle'},{e:'üîß',t:'Pack repair kit'}],
  Swim:[{e:'ü©±',t:'Pack swimwear'},{e:'ü•Ω',t:'Find your goggles'},{e:'üõÅ',t:'Pack a towel'},{e:'üèä',t:'Find swim cap'}],
  Yoga:[{e:'üßò',t:'Set out yoga mat'},{e:'üëó',t:'Lay out comfortable clothes'},{e:'üíß',t:'Fill water bottle'}],
  HIIT:[{e:'üëü',t:'Set out cross-trainers'},{e:'ü©≥',t:'Lay out workout clothes'},{e:'üíß',t:'Fill water bottle'}],
  Walk:[{e:'üëü',t:'Set out walking shoes'},{e:'üß¢',t:'Find hat or visor'},{e:'üíß',t:'Fill water bottle'}],
  Sport:[{e:'üëü',t:'Pack sport shoes'},{e:'üéΩ',t:'Pack sport kit'},{e:'üíß',t:'Fill water bottle'}],
  Ruck:[{e:'üéí',t:'Load up rucking backpack'},{e:'üß±',t:'Check ruck weight plates'},{e:'üëü',t:'Set out boots or trail shoes'},{e:'üíß',t:'Fill water bottle'}],
};

function renderEveningPrep() {
  const tomorrow=new Date(new Date().getTime()+86400000), tKey=dayKey(tomorrow), w=workouts[tKey];
  const content=document.getElementById('eveningPrepContent');
  if(!w||!w.types.length){content.innerHTML='<div class="evening-prep-empty">No workouts planned for tomorrow ‚Äî enjoy the rest!</div>';return;}
  const allItems=[]; w.types.forEach(type=>{(EVENING_MAP[type]||[]).forEach(item=>{if(!allItems.find(i=>i.t===item.t))allItems.push(item);});});
  content.innerHTML=`<p style="font-size:0.78rem;color:var(--text3);margin-bottom:12px;font-family:'DM Mono',monospace;font-weight:300;">tomorrow: <span style="color:var(--amber);">${w.types.join(' + ').toLowerCase()}</span></p><div class="evening-checklist">${allItems.map(item=>`<div class="evening-item" onclick="this.classList.toggle('checked')"><div class="evening-check">‚úì</div><span class="evening-item-emoji">${item.e}</span><span class="evening-item-text">${item.t}</span></div>`).join('')}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PLAN PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildPlanPage() {
  const today=new Date(), start=new Date(today); start.setDate(today.getDate()-today.getDay());
  const end=new Date(start); end.setDate(start.getDate()+6);
  document.getElementById('weekRangeLabel').textContent=`${MONTHS_ABB[start.getMonth()]} ${start.getDate()} ‚Äì ${MONTHS_ABB[end.getMonth()]} ${end.getDate()}`;

  const trainDays=Object.keys(workouts).filter(k=>{const [yr,mo,dt]=k.split('-').map(Number);const d=new Date(yr,mo,dt);return d>=start&&d<=end;}).length;
  const pct=Math.round((trainDays/7)*100);
  const msg=trainDays===0?'No workouts planned yet ‚Äî tap a day to add one.':trainDays<=2?`${trainDays} workout${trainDays>1?'s':''} planned ‚Äî keep building!`:trainDays<=4?`${trainDays} workouts ‚Äî solid week!`:trainDays<=6?`${trainDays} workouts ‚Äî great commitment!`:`${trainDays} workouts ‚Äî full week, incredible!`;
  document.getElementById('weekSummaryBar').innerHTML=`<div style="border-bottom:1px solid var(--border);padding-bottom:16px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><span style="font-family:'DM Sans',sans-serif;font-size:0.72rem;font-weight:400;color:var(--text2);">Weekly Activity</span><span style="font-family:'DM Mono',monospace;font-size:0.78rem;font-weight:400;color:var(--green);">${trainDays}/7</span></div><div style="height:2px;background:var(--surface2);border-radius:1px;overflow:hidden;"><div style="height:100%;width:${pct}%;background:var(--accent);border-radius:1px;transition:width 0.5s ease;"></div></div><div style="margin-top:8px;font-family:'DM Sans',sans-serif;font-size:0.72rem;font-weight:300;color:var(--text3);">${msg}</div></div>`;

  const grid=document.getElementById('weekPlanGrid'); grid.innerHTML='';
  for(let i=0;i<7;i++){
    const d=new Date(start); d.setDate(start.getDate()+i); const key=dayKey(d); const w=workouts[key]; const isToday=key===dayKey(today);
    const row=document.createElement('div');
    row.className='week-plan-row'+(isToday?' today':'')+(w?' has-workout':'');
    row.onclick=()=>{
      switchTab('workouts',document.querySelectorAll('.tab')[2]);
      setTimeout(()=>{buildWeekStrip();const pill=document.querySelector(`[data-key="${key}"]`);if(pill)openPanel(pill,key,`${DAYS_LONG[d.getDay()]}, ${MONTHS[d.getMonth()]} ${d.getDate()}`);},120);
    };
    let contentHtml=w&&w.types.length?`<div class="week-plan-workout-chips">${w.types.map(t=>`<span class="chip green" style="font-size:0.7rem;padding:4px 10px;">${t}</span>`).join('')}</div>${w.note?`<div class="week-plan-note">${w.note}</div>`:''}`:(isToday?`<div class="week-plan-add-hint">+ Add today's workout</div>`:`<div class="week-plan-rest">Rest day</div>`);
    row.innerHTML=`<div class="week-plan-day-col"><span class="week-plan-day-abbr">${DAYS_ABB[d.getDay()]}</span><span class="week-plan-day-num">${d.getDate()}</span></div><div class="week-plan-content">${contentHtml}</div><div class="week-plan-edit-col">‚Ä∫</div>`;
    grid.appendChild(row);
  }

  const todayTodos=todos[todayTodoKey()]||[], tmTodos=todos[tomorrowTodoKey()]||[];
  let todoHtml='';
  if(todayTodos.length) todoHtml+=`<div style="border-left:1px solid var(--accent);padding:12px 16px;margin-bottom:10px;"><div style="font-family:'DM Sans',sans-serif;font-size:0.6rem;font-weight:400;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:6px;">Today's To-Do</div>${todayTodos.map(t=>`<p style="font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:300;color:${t.done?'var(--text3)':'var(--text)'};line-height:1.6;${t.done?'text-decoration:line-through;':''}">${t.done?'‚úì ':'‚óã '}${t.text}</p>`).join('')}</div>`;
  if(tmTodos.length) todoHtml+=`<div style="border-left:1px solid var(--border2);padding:12px 16px;"><div style="font-family:'DM Sans',sans-serif;font-size:0.6rem;font-weight:400;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:6px;">Tomorrow's To-Do</div>${tmTodos.map(t=>`<p style="font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:300;color:var(--text2);line-height:1.6;">‚óã ${t.text}</p>`).join('')}</div>`;
  if(!todayTodos.length&&!tmTodos.length) todoHtml=`<div style="color:var(--text3);font-family:'DM Sans',sans-serif;font-size:0.8rem;font-weight:300;">No to-dos set. <span onclick="switchTab('morning',document.querySelectorAll('.tab')[0]);setTimeout(()=>document.getElementById('todoInput').focus(),200);" style="color:var(--accent);cursor:pointer;">Add one ‚Üí</span></div>`;
  document.getElementById('planTodoBlock').innerHTML=todoHtml;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WORKOUTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dayKey(d){return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;}

function buildWeekStrip(){
  const strip=document.getElementById('weekStrip'); strip.innerHTML='';
  const today=new Date(), start=new Date(today); start.setDate(today.getDate()-today.getDay());
  for(let i=0;i<7;i++){
    const d=new Date(start); d.setDate(start.getDate()+i); const key=dayKey(d);
    const btn=document.createElement('button');
    btn.className='day-pill'+(key===dayKey(today)?' today':'')+(workouts[key]?' has-workout':'');
    btn.dataset.key=key;
    btn.innerHTML=`<span class="day-pill-abbr">${DAYS_ABB[d.getDay()]}</span><span class="day-pill-num">${d.getDate()}</span>`;
    btn.onclick=()=>openPanel(btn,key,`${DAYS_LONG[d.getDay()]}, ${MONTHS[d.getMonth()]} ${d.getDate()}`);
    strip.appendChild(btn);
  }
}

function openPanel(btn,key,label){
  document.querySelectorAll('.day-pill').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected'); selectedDayKey=key; selectedTypes=workouts[key]?.types?[...workouts[key].types]:[];
  document.getElementById('workoutPanelTitle').textContent=label;
  document.getElementById('workoutNote').value=workouts[key]?.note||'';
  document.querySelectorAll('.wtype-btn').forEach(b=>b.classList.toggle('selected',selectedTypes.includes(b.dataset.type)));
  const panel=document.getElementById('workoutPanel'); panel.classList.add('visible'); panel.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function closePanel(){document.getElementById('workoutPanel').classList.remove('visible');document.querySelectorAll('.day-pill').forEach(b=>b.classList.remove('selected'));selectedDayKey=null;}

function toggleWType(btn){const type=btn.dataset.type;btn.classList.toggle('selected');selectedTypes.includes(type)?(selectedTypes=selectedTypes.filter(t=>t!==type)):selectedTypes.push(type);}

function saveWorkout(){
  if(!selectedDayKey)return;
  const note=document.getElementById('workoutNote').value.trim();
  if(selectedTypes.length===0)delete workouts[selectedDayKey]; else workouts[selectedDayKey]={types:[...selectedTypes],note};
  localStorage.setItem('dr_workouts',JSON.stringify(workouts));
  closePanel(); buildWeekStrip(); renderWorkoutList(); renderPackList(); renderEveningPrep(); renderStretches();
  showToast('workout saved');
}

function renderWorkoutList(){
  const list=document.getElementById('workoutList'), keys=Object.keys(workouts);
  if(!keys.length){list.innerHTML='<div class="empty"><div class="empty-icon">üí™</div><div class="empty-text">Tap a day above to add a workout.</div></div>';return;}
  list.innerHTML=keys.map(key=>{const w=workouts[key];const [yr,mo,dt]=key.split('-').map(Number);const d=new Date(yr,mo,dt);return `<div class="workout-day-row"><div class="workout-day-label">${DAYS_ABB[d.getDay()]} ${d.getDate()}</div><div class="workout-day-types">${w.types.map(t=>`<span class="chip green" style="font-size:0.72rem;">${t}</span>`).join('')}${w.note?`<span class="chip" style="font-size:0.72rem;font-style:italic;">${w.note}</span>`:''}</div><button class="workout-day-del" onclick="deleteWorkout('${key}')">‚úï</button></div>`;}).join('');
}

function deleteWorkout(key){delete workouts[key];localStorage.setItem('dr_workouts',JSON.stringify(workouts));buildWeekStrip();renderWorkoutList();renderPackList();renderEveningPrep();renderStretches();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PACK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PACK_MAP={Run:[{e:'üëü',t:'Running shoes'},{e:'ü©≥',t:'Athletic shorts / tights'},{e:'üß¢',t:'Cap or headband'},{e:'üíß',t:'Water bottle'}],Lift:[{e:'üèãÔ∏è',t:'Gym shoes'},{e:'üëï',t:'Workout shirt'},{e:'ü©≥',t:'Athletic shorts'},{e:'üíß',t:'Water bottle'}],Bike:[{e:'üö¥',t:'Helmet'},{e:'üö≤',t:'Cycling shorts'},{e:'üíß',t:'Water bottle'},{e:'üîß',t:'Repair kit'}],Swim:[{e:'ü©±',t:'Swimwear'},{e:'ü•Ω',t:'Goggles'},{e:'üèä',t:'Swim cap'},{e:'üõÅ',t:'Towel'}],Yoga:[{e:'üßò',t:'Yoga mat'},{e:'üëó',t:'Comfortable leggings'},{e:'üß¶',t:'Grip socks'}],HIIT:[{e:'üëü',t:'Cross-trainers'},{e:'ü©≥',t:'Athletic clothes'},{e:'üíß',t:'Water bottle'}],Walk:[{e:'üëü',t:'Comfortable shoes'},{e:'üß¢',t:'Hat or visor'},{e:'üíß',t:'Water bottle'}],Sport:[{e:'üëü',t:'Sport shoes'},{e:'üéΩ',t:'Sport kit'},{e:'üíß',t:'Water bottle'}],Ruck:[{e:'üéí',t:'Large rucking backpack'},{e:'üß±',t:'Ruck weight plates'},{e:'üëü',t:'Sturdy boots or trail shoes'},{e:'ü©≥',t:'Athletic clothes'},{e:'üíß',t:'Water bottle'},{e:'üß¢',t:'Cap or headband'}]};
const BASE_PACK=[{e:'üëï',t:'Change of clothes'},{e:'üß¥',t:'Deodorant / toiletries'}];

function renderPackList(){
  const content=document.getElementById('packContent'), keys=Object.keys(workouts);
  if(!keys.length){content.innerHTML='<div class="empty"><div class="empty-icon">üéí</div><div class="empty-text">Add workouts to see your pack list here.</div></div>';return;}
  content.innerHTML=keys.map(key=>{const w=workouts[key];const [yr,mo,dt]=key.split('-').map(Number);const d=new Date(yr,mo,dt);const allItems=[...BASE_PACK];w.types.forEach(type=>{(PACK_MAP[type]||[]).forEach(item=>{if(!allItems.find(i=>i.t===item.t))allItems.push(item);});});return `<div class="pack-section"><div class="pack-section-header"><div class="pack-section-day">${DAYS_LONG[d.getDay()]}, ${d.getDate()}</div><div class="pack-section-types">${w.types.map(t=>`<span class="chip green" style="font-size:0.65rem;">${t}</span>`).join('')}</div></div>${allItems.map(item=>`<div class="pack-item" onclick="this.classList.toggle('checked')"><div class="pack-check">‚úì</div><span class="pack-item-emoji">${item.e}</span><span class="pack-item-text">${item.t}</span></div>`).join('')}</div>`;}).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STRETCHES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STRETCH_MAP={
  General:[{e:'üôÜ',t:'Neck rolls ‚Äî slowly circle each direction',h:'30s each'},{e:'ü§∑',t:'Shoulder rolls ‚Äî forward then backward',h:'30s each'},{e:'üê±',t:'Cat-cow ‚Äî arch and round your back',h:'30s'},{e:'üîÑ',t:'Seated spinal twist ‚Äî both sides',h:'20s each'},{e:'üôá',t:'Standing forward fold ‚Äî hang loose',h:'30s'},{e:'ü¶µ',t:'Figure-four stretch ‚Äî each leg',h:'20s each'}],
  Run:[{e:'ü¶µ',t:'Standing quad stretch ‚Äî each leg',h:'30s each'},{e:'ü¶∂',t:'Calf stretch against a wall ‚Äî each side',h:'30s each'},{e:'üßé',t:'Kneeling hip flexor stretch ‚Äî each side',h:'30s each'},{e:'ü¶ø',t:'Standing hamstring stretch ‚Äî each leg',h:'30s each'},{e:'üèÉ',t:'IT band stretch ‚Äî cross-leg lean each side',h:'20s each'}],
  Lift:[{e:'üí™',t:'Cross-body shoulder stretch ‚Äî each arm',h:'20s each'},{e:'üôÜ',t:'Chest doorway stretch ‚Äî both arms',h:'30s'},{e:'ü§∏',t:'Lat stretch ‚Äî side lean each way',h:'20s each'},{e:'üí™',t:'Tricep overhead stretch ‚Äî each arm',h:'20s each'},{e:'ü§≤',t:'Wrist circles ‚Äî both directions',h:'20s each'}],
  Bike:[{e:'ü¶µ',t:'Standing quad stretch ‚Äî each leg',h:'30s each'},{e:'üßé',t:'Kneeling hip flexor stretch ‚Äî each side',h:'30s each'},{e:'ü¶∂',t:'Calf stretch against a wall ‚Äî each side',h:'30s each'},{e:'üôá',t:'Seated lower back stretch ‚Äî fold forward',h:'30s'},{e:'üôÜ',t:'Neck side tilts ‚Äî each direction',h:'20s each'}],
  Swim:[{e:'üîÑ',t:'Arm circles ‚Äî small to large both ways',h:'30s each'},{e:'üôÜ',t:'Chest opener stretch ‚Äî clasp hands behind',h:'30s'},{e:'üßé',t:'Kneeling hip flexor stretch ‚Äî each side',h:'30s each'},{e:'ü¶∂',t:'Ankle circles ‚Äî each direction',h:'20s each'},{e:'üí™',t:'Cross-body shoulder stretch ‚Äî each arm',h:'20s each'}],
  Yoga:[{e:'üßí',t:'Child\'s pose ‚Äî reach arms forward',h:'45s'},{e:'üêï',t:'Downward dog ‚Äî pedal feet gently',h:'30s'},{e:'üêç',t:'Cobra stretch ‚Äî gentle back extension',h:'20s'},{e:'üßò',t:'Pigeon pose ‚Äî each side',h:'30s each'},{e:'üôá',t:'Standing forward fold ‚Äî hang loose',h:'30s'}],
  HIIT:[{e:'üö∂',t:'Walking lunges ‚Äî dynamic warm-up',h:'10 each'},{e:'üîÑ',t:'Arm circles ‚Äî forward and backward',h:'20s each'},{e:'üîÑ',t:'Hip circles ‚Äî each direction',h:'20s each'},{e:'ü¶∂',t:'Ankle rotations ‚Äî each foot',h:'15s each'},{e:'ü¶µ',t:'Leg swings ‚Äî front to back each leg',h:'15s each'}],
  Walk:[{e:'ü¶∂',t:'Calf stretch against a wall ‚Äî each side',h:'30s each'},{e:'ü¶µ',t:'Standing quad stretch ‚Äî each leg',h:'30s each'},{e:'üîÑ',t:'Hip circles ‚Äî each direction',h:'20s each'},{e:'ü¶∂',t:'Ankle rotations ‚Äî each foot',h:'15s each'}],
  Sport:[{e:'üö∂',t:'Walking lunges ‚Äî dynamic warm-up',h:'10 each'},{e:'ü¶µ',t:'Leg swings ‚Äî front to back each leg',h:'15s each'},{e:'üîÑ',t:'Arm circles ‚Äî forward and backward',h:'20s each'},{e:'üßé',t:'Kneeling hip flexor stretch ‚Äî each side',h:'30s each'},{e:'ü¶µ',t:'Standing hamstring stretch ‚Äî each leg',h:'20s each'}],
  Ruck:[{e:'üßé',t:'Kneeling hip flexor stretch ‚Äî each side',h:'30s each'},{e:'ü¶∂',t:'Calf stretch against a wall ‚Äî each side',h:'30s each'},{e:'ü§∑',t:'Shoulder rolls ‚Äî forward then backward',h:'30s each'},{e:'üôá',t:'Seated lower back stretch ‚Äî fold forward',h:'30s'},{e:'ü¶µ',t:'Standing quad stretch ‚Äî each leg',h:'30s each'}]
};

function renderStretches(){
  const content=document.getElementById('stretchContent');
  const today=new Date(), tKey=dayKey(today), w=workouts[tKey];
  let html='';
  if(w&&w.types.length){
    w.types.forEach(type=>{
      const stretches=STRETCH_MAP[type];
      if(!stretches)return;
      html+=`<div class="stretch-section"><div class="stretch-section-title">${type} Stretches</div>`;
      html+=stretches.map(s=>`<div class="stretch-item" onclick="this.classList.toggle('checked')"><div class="stretch-check">‚úì</div><span class="stretch-emoji">${s.e}</span><span class="stretch-text">${s.t}</span><span class="stretch-hold">${s.h}</span></div>`).join('');
      html+=`</div>`;
    });
  }
  html+=`<div class="stretch-section"><div class="stretch-section-title">${w&&w.types.length?'General Recovery':'Daily Stretch Routine'}</div>`;
  html+=STRETCH_MAP.General.map(s=>`<div class="stretch-item" onclick="this.classList.toggle('checked')"><div class="stretch-check">‚úì</div><span class="stretch-emoji">${s.e}</span><span class="stretch-text">${s.t}</span><span class="stretch-hold">${s.h}</span></div>`).join('');
  html+=`</div>`;
  if(customStretches.length){
    html+=`<div class="stretch-section"><div class="stretch-section-title">Your Stretches</div>`;
    html+=customStretches.map((s,i)=>`<div class="stretch-item" onclick="this.classList.toggle('checked')"><div class="stretch-check">‚úì</div><span class="stretch-emoji">‚≠ê</span><span class="stretch-text">${s.t}</span><span class="stretch-hold">${s.h}</span><button class="stretch-del" onclick="event.stopPropagation();deleteCustomStretch(${i})">‚úï</button></div>`).join('');
    html+=`</div>`;
  }
  content.innerHTML=html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CALORIE CALCULATOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadCalcProfile(){
  try{
    const p=JSON.parse(localStorage.getItem('dr_calc_profile')||'null');
    if(!p)return;
    if(p.sex)document.getElementById('calcSex').value=p.sex;
    if(p.age)document.getElementById('calcAge').value=p.age;
    if(p.weight)document.getElementById('calcWeight').value=p.weight;
    if(p.heightFt)document.getElementById('calcHeightFt').value=p.heightFt;
    if(p.heightIn)document.getElementById('calcHeightIn').value=p.heightIn;
    if(p.activity)document.getElementById('calcActivity').value=p.activity;
  }catch(_){}
  autoDetectActivity();
}

function autoDetectActivity(){
  const today=new Date(), start=new Date(today); start.setDate(today.getDate()-today.getDay());
  let count=0;
  for(let i=0;i<7;i++){const d=new Date(start);d.setDate(start.getDate()+i);if(workouts[dayKey(d)])count++;}
  const sel=document.getElementById('calcActivity');
  if(count===0)sel.value='1.2';
  else if(count<=2)sel.value='1.375';
  else if(count<=4)sel.value='1.55';
  else if(count<=6)sel.value='1.725';
  else sel.value='1.9';
}

function calculateCalories(){
  const sex=document.getElementById('calcSex').value;
  const age=parseInt(document.getElementById('calcAge').value);
  const weightLbs=parseFloat(document.getElementById('calcWeight').value);
  const htFt=parseInt(document.getElementById('calcHeightFt').value)||0;
  const htIn=parseInt(document.getElementById('calcHeightIn').value)||0;
  const activity=parseFloat(document.getElementById('calcActivity').value);
  if(!age||!weightLbs||(!htFt&&!htIn)){showToast('fill in all fields');return;}
  const weightKg=weightLbs*0.453592;
  const heightCm=(htFt*12+htIn)*2.54;
  let bmr;
  if(sex==='male')bmr=10*weightKg+6.25*heightCm-5*age+5;
  else bmr=10*weightKg+6.25*heightCm-5*age-161;
  const tdee=Math.round(bmr*activity);
  bmr=Math.round(bmr);
  document.getElementById('calcBMR').textContent=`${bmr.toLocaleString()} cal`;
  document.getElementById('calcTDEE').textContent=`${tdee.toLocaleString()} cal`;
  const labels={'1.2':'sedentary','1.375':'lightly active','1.55':'moderately active','1.725':'very active','1.9':'extra active'};
  document.getElementById('calcNote').textContent=`Based on ${labels[String(activity)]||'your'} activity level (√ó${activity}). BMR is calories at rest ‚Äî TDEE accounts for your physical activity.`;
  document.getElementById('calcResult').classList.add('visible');
  localStorage.setItem('dr_calc_profile',JSON.stringify({sex,age,weight:weightLbs,heightFt:htFt,heightIn:htIn,activity:String(activity)}));
  showToast('calories calculated');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCHEDULE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSchedType(btn){const type=btn.dataset.type;btn.classList.toggle('selected');scheduleTypes.includes(type)?(scheduleTypes=scheduleTypes.filter(t=>t!==type)):scheduleTypes.push(type);}

function applySchedule(){
  if(!scheduleTypes.length){showToast('select workout types first');return;}
  const freq=parseInt(document.getElementById('scheduleFreq').value);
  const today=new Date(), start=new Date(today); start.setDate(today.getDate()-today.getDay());
  for(let i=0;i<7;i++){
    if(i%freq!==0)continue;
    const d=new Date(start);d.setDate(start.getDate()+i);const key=dayKey(d);
    const existing=workouts[key];
    if(existing){const merged=[...new Set([...existing.types,...scheduleTypes])];workouts[key]={types:merged,note:existing.note};}
    else{workouts[key]={types:[...scheduleTypes],note:''};}
  }
  localStorage.setItem('dr_workouts',JSON.stringify(workouts));
  buildWeekStrip();renderWorkoutList();renderPackList();renderEveningPrep();renderStretches();
  showToast('schedule applied');
}

function clearSchedule(){
  const today=new Date(), start=new Date(today); start.setDate(today.getDate()-today.getDay());
  for(let i=0;i<7;i++){const d=new Date(start);d.setDate(start.getDate()+i);delete workouts[dayKey(d)];}
  localStorage.setItem('dr_workouts',JSON.stringify(workouts));
  buildWeekStrip();renderWorkoutList();renderPackList();renderEveningPrep();renderStretches();
  showToast('week cleared');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CUSTOM STRETCHES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addCustomStretch(){
  const nameEl=document.getElementById('customStretchName'), holdEl=document.getElementById('customStretchHold');
  const name=nameEl.value.trim(), hold=holdEl.value.trim()||'30s';
  if(!name){showToast('enter a stretch name');return;}
  customStretches.push({t:name,h:hold});
  localStorage.setItem('dr_custom_stretches',JSON.stringify(customStretches));
  nameEl.value='';holdEl.value='';renderStretches();showToast('stretch added');
}

function deleteCustomStretch(i){
  customStretches.splice(i,1);
  localStorage.setItem('dr_custom_stretches',JSON.stringify(customStretches));
  renderStretches();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let notifTimer = null;

function loadNotifSettings() {
  const saved = localStorage.getItem('dr_notif_time');
  const enabled = localStorage.getItem('dr_notif_enabled') === 'true';
  if (saved) document.getElementById('notifTime').value = saved;
  updateNotifUI(enabled);
  if (enabled) scheduleNotification();
}

function updateNotifUI(enabled) {
  const btn = document.getElementById('notifEnableBtn');
  const status = document.getElementById('notifStatus');
  if (enabled) {
    btn.textContent = 'Disable Notifications';
    btn.style.background = 'var(--surface2)';
    btn.style.color = 'var(--text2)';
    btn.style.border = '1px solid var(--border)';
    const time = localStorage.getItem('dr_notif_time') || '07:00';
    const [h,m] = time.split(':').map(Number);
    const ampm = h >= 12 ? 'pm' : 'am';
    const hh = h % 12 || 12;
    status.textContent = `‚úì notification scheduled for ${hh}:${String(m).padStart(2,'0')} ${ampm}`;
    status.style.color = 'var(--green)';
  } else {
    btn.textContent = 'Enable Notifications';
    btn.style.background = 'var(--accent)';
    btn.style.color = 'var(--bg)';
    btn.style.border = 'none';
    status.textContent = '';
  }
}

async function toggleNotifications() {
  const enabled = localStorage.getItem('dr_notif_enabled') === 'true';
  if (enabled) {
    localStorage.setItem('dr_notif_enabled', 'false');
    if (notifTimer) clearTimeout(notifTimer);
    updateNotifUI(false);
    showToast('notifications disabled');
    return;
  }

  if (!('Notification' in window)) {
    document.getElementById('notifStatus').textContent = '‚ö† notifications not supported in this browser';
    document.getElementById('notifStatus').style.color = 'var(--red)';
    return;
  }

  const perm = await Notification.requestPermission();
  if (perm !== 'granted') {
    document.getElementById('notifStatus').textContent = '‚ö† notification permission denied ‚Äî enable in browser settings';
    document.getElementById('notifStatus').style.color = 'var(--red)';
    return;
  }

  const time = document.getElementById('notifTime').value;
  localStorage.setItem('dr_notif_time', time);
  localStorage.setItem('dr_notif_enabled', 'true');
  updateNotifUI(true);
  scheduleNotification();
  showToast('notifications enabled');
}

function scheduleNotification() {
  if (notifTimer) clearTimeout(notifTimer);
  const time = localStorage.getItem('dr_notif_time') || '07:00';
  const [h, m] = time.split(':').map(Number);
  const now = new Date();
  const target = new Date(now);
  target.setHours(h, m, 0, 0);
  if (target <= now) target.setDate(target.getDate() + 1);
  const ms = target - now;
  notifTimer = setTimeout(() => {
    sendMorningNotification();
    scheduleNotification();
  }, ms);
}

function sendMorningNotification() {
  if (Notification.permission !== 'granted') return;
  const pending = (todos[todayTodoKey()]||[]).filter(t=>!t.done).map(t=>t.text);
  const today = new Date();
  const tKey = dayKey(today);
  const w = workouts[tKey];
  let body = '';
  if (pending.length) body += `‚ú¶ ${pending.join(' / ')}\n`;
  if (w && w.types.length) body += `üèãÔ∏è Today: ${w.types.join(' + ')}`;
  else body += 'üåø Rest day ‚Äî recovery is part of the work.';
  if (weatherData) body += `\n${WMO_ICONS[weatherData.code]||'üå§'} ${weatherData.temp}¬∞F, ${WMO_CODES[weatherData.code]||''}`;

  new Notification('Good Morning ‚òÄÔ∏è', {
    body: body,
    icon: '‚òÄÔ∏è',
    tag: 'dayready-morning',
    requireInteraction: true
  });
}

// Save notif time on change
document.getElementById('notifTime').addEventListener('change', function() {
  localStorage.setItem('dr_notif_time', this.value);
  if (localStorage.getItem('dr_notif_enabled') === 'true') {
    scheduleNotification();
    updateNotifUI(true);
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg,dur=2600){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),dur);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadTodos();
buildWeekStrip();
renderWorkoutList();
renderPackList();
renderEveningPrep();
renderStretches();
loadCalcProfile();
loadNotifSettings();
if('geolocation' in navigator) loadWeather();
else document.querySelector('.weather-loading').innerHTML='<span style="color:var(--red);font-size:0.78rem;">‚ö† Location not available.</span>';
</script>

</body>
</html>